<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <style>
        body {
            font-family: Helvetica;
        }
        #wrap {
            width: 1000px;
            margin: 0 auto;
        }
        #slider { margin: 10px; }
        </style>
    </head>
    <body style="background: #DDD;">
 
       <div id="wrap">
       <h1>threshold</h1>
       <p>move slider</p>

		<div>
			<div id="startDateLabel" style="float:left"></div>
			<div id="endDateLabel" style="float:right"></div>
		</div>
		<div style="clear:both" > </div>

       <div id="slider"></div>
       <div id="slider_value">0</div>
       <canvas id="R" style="background:#fff" ></canvas>
       </div>

       <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
       <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
       <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
       <script type="text/javascript" src="pixel_ops.js"></script>
       <script>
            // from http://www.williammalone.com/articles/html5-canvas-javascript-paint-bucket-tool/#subTitle4
      
            $(document).ready(function() {

				// go over each pixel of the image_data, one by one, based on 
				/**
				@param w - width
				@param h - height
				@param threshold - Calculated value, float, values 0-255
				*/
                function filter(image_data, w, h, threshold) {
                    var components = 4; //rgba
                    var pixel_pos;

					// go over each column
                    for(var i=0; i < w; ++i) {
						
						// each row 
                        for(var j=0; j < h; ++j) {
							// image data is just an array, from 0 => total num of pixels, 
							// ... * 4, because there are 4 channels (RGB + alpha) with a 0-255 value
							// ordered by R G B A values
                            var pixel_pos = (j*w + i) * components;

							// so right now just, looks at value of Red channel
							
							// skip over clear (alpha=0) pixels
							if( image_data[pixel_pos+3] == 0 ){
								continue;
							}
							var pixelRValue = image_data[pixel_pos];
                            if(image_data[pixel_pos] < threshold ) 
							{
	
								// Its beneath the threshold, so zero out all the values
								// image_data[pixel_pos] 		= 0;
								// image_data[pixel_pos + 1]	= 0; 
								// image_data[pixel_pos + 2]	= 0;
								// image_data[pixel_pos + 3]	= 0;
								
								image_data[pixel_pos] 		= 56;
								image_data[pixel_pos + 1]	= 112;
								image_data[pixel_pos + 2]	= 38;
								image_data[pixel_pos + 3]	= 255;
                            }else{
								// OVER THE THRESHOLD
								image_data[pixel_pos] 		= maxR;
								image_data[pixel_pos + 1]	= minG;
								// image_data[pixel_pos] 		= maxR - (pixelRValue-threshold)/255.0 * (maxR-minR);
								// image_data[pixel_pos + 1]	= minG + (pixelRValue-threshold)/255.0 * (maxG-minG);
								image_data[pixel_pos + 2]	= 0;
								image_data[pixel_pos + 3]	= 255;
							}
                        }
                    }
                };

				// ecohack - color range
				var minR = 56;
				var maxR = 188;
				var minG = 3;
				var maxG = 112;

                var cnvs = document.getElementById('R');
                var ctx = cnvs.getContext('2d');
				
				
				// ecohack new
				var maxValueForSliderLabel	= 8000;
				var defaultStartAlpha 		= 0;	// 0-100
				var startDate	= new Date(2006, 0, 1); // Jan 1, 2006
				var endDate		= new Date(2011, 7, 31); // Aug 31, 2011
				
				$("#startDateLabel").html( formatDate(startDate) +"");
				$("#endDateLabel").html(  formatDate(endDate) +"");
				// end ecohack new

				function getDateForPercent(percentage){
					var diffBtwDates = endDate.getTime() - startDate.getTime();
					console.log('perceht is : ' + percentage + ", diff between dates: " + endDate.getTime() );
					var newDate = new Date(startDate.getTime() + diffBtwDates*percentage / 100.0);
					return newDate;
				}

				function formatDate(dateToFormat){
					var monthNames = new Array("Jan", "Feb", "Mar", 
										"Apr", "May", "Jun", "Jul", "Aug", "Sep", 
										"Oct", "Nov", "Dec");
					var curr_date	= dateToFormat.getDate();
					var curr_month	= dateToFormat.getMonth();
					var curr_year	= dateToFormat.getFullYear();
					return  monthNames[curr_month] + " " + curr_date   + ", " + curr_year;
				}

                // load image
                var image = new Image();  
//                image.src = "compose.png"; 
 				image.src = "forma_ecohacknyc.png"
          
                $(image).load(function() {  
                    ctx.width = cnvs.width = image.width;
                    ctx.height = cnvs.height = image.height;
                    ctx.drawImage(image, 0, 0);  

					// Draw the image, with filter at 100 ... so it removes the entire image by default
					var I = ctx.getImageData(0, 0, cnvs.width, cnvs.height);
					filter(I.data, ctx.width, ctx.height, 70* (100-defaultStartAlpha)/100.0);
					ctx.putImageData(I,0,0);

                    var offset = $(cnvs).offset();

                    $("#slider").slider({
                        slide: function(event, ui) {  
							// alert('the ui value is : ' + ui.value);
							var adjustedVal = (100 - ui.value);
							// $("#slider_value").html(maxValueForSliderLabel * ui.value/100.0);
							// $("#slider_value").html(maxValueForSliderLabel * adjustedVal/100.0);
							$("#slider_value").html( formatDate( getDateForPercent(adjustedVal)) );

                            ctx.drawImage(image, 0, 0);  
                            var I = ctx.getImageData(0, 0, cnvs.width, cnvs.height);
                            filter(I.data, ctx.width, ctx.height, 70.0*adjustedVal/100.0);
                            ctx.putImageData(I,0,0);
                        }
                    });


					
                });  
            });

            /*
            */

        </script>
    </body>
</html>
