<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <title>Visual Raster: tile manipulation using Canvas</title>
        <style>
        body, html{
            font-family: Helvetica;
            height: 100%;
        }
        #wrap {
            width: 80%%;
            height: 100%;
            margin: 0 auto;
        }
		#slider_controls { 
			width: 80%; 
            margin: 0 auto;
		}
        #slider { 
			margin: 10px; 
		}
        #map {
            width: 100%;
            height: 500px;
        }
        #map_wrapper {
            margin-top: 20px;
            border: 1px solid #DDD;
            padding: 4px;
        }
				
				
        </style>
    </head>
    <body style="background: #FFF;">
	<div id="wrap">
		<div id="header">
			<h1>Deforestation in Indonesia</h1>
			<p>Time-based visualization of deforestation, detected by satellite imaging, from Jan 2006, thru August 2011.</p>
			<div id="slider_controls">
		       	<p>Move the slider to show deforestation (marked as red) at certain dates.</p>
				<div>
					<div id="startDateLabel" style="float:left"></div>
					<div id="endDateLabel" style="float:right"></div>
				</div>
				<div style="clear:both" > </div>
		
		       	<div id="slider"></div>
		       	<div id="slider_value"></div>
			</div>
		</div>



       	<!--<div id="current_canvas">0</div>-->
       	<div id="map_wrapper">
        <div id="map"></div>
       	</div>
       </div>

       <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
       <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
       <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
       <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
       <script type="text/javascript" src="canvas_tile_layer.js"></script>

       <script>
           var App = function(){


				// ecohack new
				var maxValueForSliderLabel	= 8000;
				var defaultStartAlpha 		= 0;	// 0-100
				var startDate	= new Date(2006, 0, 1); // Jan 1, 2006
				var endDate		= new Date(2011, 7, 31); // Aug 31, 2011
				
				$("#startDateLabel").html( formatDate(startDate) +"");
				$("#endDateLabel").html(  formatDate(endDate) +"");
				$("#slider_value").html( formatDate( startDate ) );

				// end ecohack new

				function getDateForPercent(percentage){
					var diffBtwDates = endDate.getTime() - startDate.getTime();
					// console.log('percent is : ' + percentage + ", diff between dates: " + endDate.getTime() );
					var newDate = new Date(startDate.getTime() + diffBtwDates*percentage / 100.0);
					return newDate;
				}

				function formatDate(dateToFormat){
					var monthNames = new Array("Jan", "Feb", "Mar", 
										"Apr", "May", "Jun", "Jul", "Aug", "Sep", 
										"Oct", "Nov", "Dec");
					var curr_date	= dateToFormat.getDate();
					var curr_month	= dateToFormat.getMonth();
					var curr_year	= dateToFormat.getFullYear();
					return  monthNames[curr_month] + " " + curr_date   + ", " + curr_year;
				}
	
               var me = {
                   mapOptions: {
                       zoom: 4,
                       center: new google.maps.LatLng(0.3067, 110.67),
                       mapTypeId: google.maps.MapTypeId.ROADMAP
                   }                
               };

               me.init = function(){
                   this.heightLayer = new CanvasTileLayer();

                   var map = new google.maps.Map(document.getElementById("map"), this.mapOptions);
                   map.overlayMapTypes.insertAt(0, this.heightLayer);
                   this.setup_ui();								
               };

               me.setup_ui = function(){								
                   var that = this;
                   $("#slider").slider({
                       slide: function(event, ui) {  
	   var my_slider_val = (ui.value / 100.0) * 68.0 + 1;
	   //console.log(my_slider_val);
           // $("#slider_value").html(8000*ui.value/100.0 + " meters");
							$("#slider_value").html( formatDate( getDateForPercent(ui.value)) );

                           that.heightLayer.filter_tiles(my_slider_val);
                       }
                   });
               };							

               return me;
           }();

           $(document).ready(function() {
               App.init();
           });
       </script>
  </body>
</html>